{% extends "base.html" %}
{% block title %} Shopping List {% endblock %}
{% block head %}
{{super()}}
{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row mb-2">
        <nav class="col-12 topbar" role="navigation" id="shopMenu">
            <ul class="nav nav-pills flex-row px-0">
                <li class="nav-item"><a class="nav-link" aria-expanded="true" data-toggle="pill" role="pill" href="#lists">Lists</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="pill" role="pill" href="#categories">Categories</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="pill" role="pill" href="#shops">Shops</a></li>
            </ul>
        </nav>
    </div>
    <div class="tab-content">
        <div id="lists" class="tab-pane fade-in">
            <ul id="lists" class="list-group">
                {% for list in lists %}
                <div class="list-group-item py-0 border-left-0 border-right-0 rounded-0">
                    <div class="d-flex flex-row w-100 align-items-center justify-content-end">
                        <a href="{{ url_for('shopapp.show_list',slist=list.name) }}" class="" style="font-size:120%">{{ list.name }}</a><span class="badge badge-info badge-pill mx-2" id="{{ list.name }}"></span>
                        <small class="mx-4">{{ list.date.strftime('%d %b %y') }}</small>
                        <button class="btn btn-link ml-auto h-50" href="#"><i class="fa fa-edit fa-lg"></i></button>
                        <button id="{{ list.name }}" data-url="{{ url_for('shopapp.delList', slist_id=list.id) }}" class="btn btn-link mx-2 h-50 delList"><i class="fa fa-trash fa-lg"></i></button>
                    </div>
                    <p class="mb-1" style="font-size:90%">{{ list.note }}</p>
                </div>
                {% endfor %}

            </ul>
            <button class="btn btn-outline-primary my-2" style="border-radius:24px" data-toggle="modal" data-target="#newList">+New List</button>
        </div>
        <div id="categories" class="tab-pane fade-in">
            <ul id="categories" class="list-group">
                {% for cat in cats %}
                <div class="list-group-item py-0 border-left-0 border-right-0 rounded-0">
                    <div class="d-flex flex-row w-100 align-items-center justify-content-end">
                        <a class="mb-1" style="font-size:120%" href="{{ url_for('shopapp.show_cat',cat_id=cat.id) }}">{{ cat.name }}</a>
                        <a class="btn btn-link ml-auto h-50" href="#"><i class="fa fa-edit fa-lg"></i></a>
                        <button id="{{ cat.name }}" data-url="{{ url_for('shopapp.delCat', cat_id=cat.id) }}" class="btn btn-link mx-2 h-50 delCat"><i class="fa fa-trash fa-lg"></i></button>
                    </div>
                    <p class="mb-1" style="font-size:90%">{{ cat.note }}</p>
                </div>
                {% endfor %} 
            </ul>
            <button class="btn btn-outline-primary my-2" style="border-radius:24px" data-toggle="modal" data-target="#newCat">+New Category</button>
        </div>
        <div id="shops" class="tab-pane fade-in">
            <ul id="shops" class="list-group">
                {% for shop in shops %}
                <div class="list-group-item py-0 border-left-0 border-right-0 rounded-0">
                    <div class="d-flex flex-row w-100 align-items-center justify-content-end">
                        <p href="#" class="mb-1" style="font-size:120%">{{ shop.name }}</p>
                        <a class="btn btn-link ml-auto h-50" href="#"><i class="fa fa-edit fa-lg"></i></a>
                        <button id="{{ shop.name }}" data-url="{{ url_for('shopapp.delShop', shop_id=shop.id) }}" class="btn btn-link mx-2 h-50 delShop"><i class="fa fa-trash fa-lg"></i></button>
                    </div>
                    <p class="mb-1" style="font-size:90%">{{ shop.note }}</p>
                </div>
                {% endfor %} 
            </ul>
            <button class="btn btn-outline-primary my-2" style="border-radius:24px" data-toggle="modal" data-target="#newShop">+New Shop</button>

        </div>
    </div>
</div>

{% from 'macros.html' import make_modal %}

{% call make_modal('newList', 'Add new list', '/new-list', 'newListForm')%}
{{ listForm.csrf_token }}
<small class="my-0 py-0">{{ listForm.name.label(class='my-0') }}</small>
{{ listForm.name(required='required') }}
{% for error in listForm.errors.name %}
<span style="color: red;">[{{error}}]</span>
{% endfor %}
<small class="my-0 py-0">{{ listForm.note.label(class='my-0') }}</small>
{{ listForm.note }}
{% endcall %}

{% call make_modal('newCat', 'Add new category', '/new-cat', 'newCatForm')%}
{{ catForm.csrf_token }}
<small class="my-0 py-0">{{ catForm.name.label(class='my-0') }}</small>
{{ catForm.name(required='required') }}
{% for error in catForm.errors.name %}
<span style="color: red;">[{{error}}]</span>
{% endfor %}
<small class="my-0 py-0">{{ catForm.note.label(class='my-0') }}</small>
{{ catForm.note }}
{% endcall %}

{% call make_modal('newShop', 'Add new shop', '/new-shop', 'newShopForm')%}
{{ shopForm.csrf_token }}
<small class="my-0 py-0">{{ shopForm.name.label(class='my-0') }}</small>
{{ shopForm.name(required='required') }}
{% for error in shopForm.errors.name %}
<span style="color: red;">[{{error}}]</span>
{% endfor %}
<small class="my-0 py-0">{{ shopForm.note.label(class='my-0') }}</small>
{{ shopForm.note }}
{% endcall %}

<script type="text/javascript">
    var units = {{ units|safe }}
    var $SCRIPT_ROOT={{ request.script_root|tojson|safe }};
    var lastTab = localStorage.getItem('lastTab');
    console.log(lastTab);
    if (lastTab) {
        $('#shopMenu a[href="' + lastTab + '"]').tab('show');
    }
    else
    {
        $('#shopMenu a:first').tab('show');
        localStorage.setItem('lastTab', $('#shopMenu a:first').attr('href'));
    }

    $(document).ready(function(){
        $('.delList, .delShop, .delCat').on('click',function(){
            if(confirm('Do you want to delete '+$(this).attr('id')+'?')){
                $.post($(this).attr("data-url"));
                setTimeout(function() {
                    window.location.reload();
                },0);                

            }
        });
        $('a[data-toggle="pill"]').on('shown.bs.tab',function(e){
            var list_id=$(".tab-pane.active").attr("id");
            console.log(list_id)
            localStorage.setItem('lastTab','#' + list_id);
        });

/*        $('.badge').each(function(){
            var slist = $(this).attr('id');
            
            $.getJSON($SCRIPT_ROOT+'/_get_items',{
                slist: slist,
            },
                      function(data){
                data=data.data;
            });

            $(this).text(data);
        });
*/

    });


</script>
{% endblock %}